(function($) {
  $.fn.renderSurvey = function(options) {
    const $form = $(`
      <form method="POST" action="${options.submitUrl}">
        <h1 class="jq-rs-title">${options.question}</h1>
        <div data-contain="answers"></div>
        <div style="clear:both;"></div>

        <div data-contain="submit">
          <button disabled="disabled" class="jq-rs-btn jq-rs-centered" type="submit">Submit</button>
        </div>
      </form>
    `);
    const $answer = $(`
      <div data-value="" data-selected="0" data-contain="answer" class="jq-rs-pill jq-rs-pill-floated">
        <label></label>
      </div>
    `);
	const $answer1 = $(`
      <div data-value="" data-selected="0" data-contain="answer" class="jq-rs-pill jq-rs-pill-floated">
        <img></img>
      </div>
    `);
    const $selected = $(`<div data-role="selected" class="jq-rs-selected"></div>`);

    function formIsValid() {
      const $selected = $form.find('[data-selected="1"]');
      //const $other = $form.find('[data-contain="other"] [name="other_answer"]');
      const atLeastOneSelect = !!$selected.length;
      //const otherSpecified = !!$other.val();

      if (atLeastOneSelect) {
        return true;
      } else {
        return false;
      }
    }

    function toggleForm(enabled) {
      if (enabled) {
        $form.find('[data-contain="submit"] [type="submit"]').removeAttr('disabled');
      } else {
        $form.find('[data-contain="submit"] [type="submit"]').attr('disabled', 'disabled');
      }
    }
    key = options.key;
    arr1[key] = [];
    console.log(key);
    $.each(options.answers, (index, answer) => {
		let $answerClone;
		if(answer.includes("http")) {
			 $answerClone = $answer1.clone();
		} else {
			$answerClone = $answer.clone();
		}


      $answerClone.click((e) => {
        const selected = !!parseInt($answerClone.attr('data-selected'));
        const value = $answerClone.attr('data-value');

        if (selected) {
          var index = arr1[key].indexOf(value);
if (index > -1) {
  arr1[key].splice(index, 1);
}
          $answerClone.find('[data-role="selected"]').remove();
          $answerClone.find('input').remove();
          $answerClone.attr('data-selected', 0);
        } else {
          arr1[key].push(value);
			let $input;
		  if(answer.includes("http")){
			$input = $(`<img src="${value}">`);
		  } else {
			$input = $(`<input type="hidden" name="answers[]" value="${value}">`);
		  }
          $answerClone.append($selected.clone());
          //$answerClone.append($input);
          $answerClone.attr('data-selected', 1);
        }

        toggleForm(formIsValid());
      });
	  if(answer.includes("http")) {
		  $answerClone.attr('data-value', answer);
		  $answerClone.find('img').attr('src',answer);
		  $answerClone.find('[name="answer"]').val(answer);
      $form.find('[data-contain="answers"]').append($answerClone);
      $form.attr('')
	  } else {
      $answerClone.attr('data-value', answer);
      $answerClone.find('label').text(answer);
      $answerClone.find('[name="answer"]').val(answer);
      $form.find('[data-contain="answers"]').append($answerClone);
      $form.attr('')
	  }
    });

    $form.find('[data-contain="other"] [name="other_answer"]').on('input', () => {
      toggleForm(formIsValid());
    });

    this.append($form);

    return this;
  };
}(jQuery));
